<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>A6 Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .lb-backdrop { background: rgba(0,0,0,0.7); }

    /* Hide all main admin sections by default */
    .admin-section {
      display: none;
    }

    /* Lightbox */
    #lightbox { display: none; }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">

<!-- ========================================================= -->
<!-- ðŸ”¥ TOP NAVBAR -->
<!-- ========================================================= -->
<nav class="w-full bg-white shadow fixed top-0 left-0 z-50">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">

    <!-- Company Logo -->
    <div class="flex items-center gap-2">
      <div class="w-10 h-10 bg-blue-600 text-white rounded-lg flex items-center justify-center font-bold">
        A6
      </div>
      <span class="font-semibold text-lg text-gray-800">A6 Admin</span>
    </div>

    <!-- Logout -->
    <button id="navbar-logout"
            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm">
      Logout
    </button>

  </div>
</nav>

<!-- Fix spacing below the navbar -->
<div class="h-16"></div>

<!-- Backend base URL -->
<script>
  const BACKEND_URL =
    (location.hostname === "localhost" || location.hostname === "127.0.0.1")
      ? "http://localhost:3000"
      : "https://a6cars.onrender.com";

  function api(path){
    if (location.hostname === "localhost") return path;
    return BACKEND_URL + path;
  }
</script>

<!-- ========================================================= -->
<!-- LOGIN SCREEN -->
<!-- ========================================================= -->
<div id="admin-login" class="max-w-md mx-auto mt-16 px-4">
  <div class="bg-white shadow rounded-lg p-6">
    <h1 class="text-2xl font-bold">A6 Admin</h1>
    <p class="text-sm text-gray-500 mb-6">Sign in to continue</p>

    <div class="space-y-3">
      <input id="admin-email" class="w-full p-3 border rounded" placeholder="Admin Email">
      <input id="admin-password" type="password" class="w-full p-3 border rounded" placeholder="Password">

      <div class="flex gap-3">
        <button id="admin-login-btn"
                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
          Login
        </button>
        <span id="admin-login-msg" class="text-red-600 text-sm"></span>
      </div>
    </div>
  </div>
</div>

<!-- ========================================================= -->
<!-- MAIN DASHBOARD (hidden until login) -->
<!-- ========================================================= -->
<div id="admin-dashboard" class="hidden">

  <div class="max-w-7xl mx-auto pt-6 px-4 lg:flex lg:gap-6">

    
    <!-- LEFT SIDEBAR -->
   
    <aside id="admin-nav-card"
           class="bg-white shadow rounded-lg p-6 w-full lg:w-72 lg:sticky lg:top-24 h-max">

      <!-- Logo -->
      <div class="flex items-center gap-3 mb-6">
        <div class="w-12 h-12 bg-blue-600 text-white rounded-lg flex items-center justify-center font-bold">
          A6
        </div>
        <div>
          <div class="font-bold text-lg">A6 Admin</div>
          <div class="text-xs text-gray-500">Control Panel</div>
        </div>
      </div>

      <!-- MENU -->
      <nav class="space-y-3 text-sm">
        <button onclick="showSection('col-addcar')" class="w-full text-left hover:text-blue-600">
          Add Cars
        </button>

        <button onclick="showSection('col-carmanage')" class="w-full text-left hover:text-blue-600">
          Manage Cars
        </button>

        <button onclick="showSection('col-verify')" class="w-full text-left hover:text-blue-600">
          Verify Payment
        </button>

        <button onclick="showSection('section-business-details')" class="w-full text-left hover:text-blue-600">
          Business Details
        </button>

        <button onclick="showSection('section-all')" class="w-full text-left hover:text-blue-600">
          Show All
        </button>
      </nav>

      <hr class="my-5">

      <!-- FILTERS -->
      <div class="text-xs font-semibold mb-1">Filters</div>
      <input id="filter-search" class="w-full p-2 mb-2 border rounded text-sm" placeholder="Search">

      <div class="flex gap-2 mb-2">
        <input id="filter-from" type="date" class="w-1/2 p-2 border rounded text-sm">
        <input id="filter-to" type="date" class="w-1/2 p-2 border rounded text-sm">
      </div>

      <div class="flex gap-2">
        <button id="filter-apply" class="flex-1 bg-green-600 text-white py-2 rounded text-sm">
          Apply
        </button>
        <button id="filter-clear" class="flex-1 bg-gray-200 text-gray-900 py-2 rounded text-sm">
          Clear
        </button>
      </div>
    </aside>

    <!-- RIGHT CONTENT AREA -->

    <main id="admin-main" class="flex-1">

      <!-- TOP STATS BOX -->
      <div class="bg-white shadow rounded-lg p-6 mb-6">
        <h1 class="text-2xl font-bold">Admin Panel</h1>
        <p class="text-sm text-gray-500 mb-4">
          Manage cars, bookings and verify payments
        </p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="p-4 bg-blue-50 rounded shadow">
            <div class="text-sm text-gray-500">Total Bookings</div>
            <div id="stat-bookings" class="text-2xl font-bold">â€”</div>
          </div>

          <div class="p-4 bg-yellow-50 rounded shadow">
            <div class="text-sm text-gray-500">Pending Payments</div>
            <div id="stat-pending" class="text-2xl font-bold">â€”</div>
          </div>

          <div class="p-4 bg-green-50 rounded shadow">
            <div class="text-sm text-gray-500">Available Cars</div>
            <div id="stat-cars" class="text-2xl font-bold">â€”</div>
          </div>
        </div>
      </div>


<!-- ADD CAR SECTION  -->

<div id="col-addcar" class="admin-section bg-white shadow rounded-lg p-6 mb-6">

  <h2 class="text-xl font-semibold mb-4">Add Car (Multiple Images)</h2>

  <form id="addCarForm" enctype="multipart/form-data" class="space-y-3">

    <input name="brand" class="w-full p-3 border rounded" placeholder="Brand" required>
    <input name="model" class="w-full p-3 border rounded" placeholder="Model" required>
    <input name="year" type="number" class="w-full p-3 border rounded" placeholder="Year" required>
    <input name="daily_rate" type="number" step="0.01"
           class="w-full p-3 border rounded" placeholder="Daily Rate (INR)" required>
    <input name="location" class="w-full p-3 border rounded" placeholder="Location" required>

    <label class="text-sm text-gray-500">Upload Car Images (JPG/JPEG) â€“ Multiple Allowed</label>
    <input id="images-input" name="images" type="file" accept=".jpg,.jpeg"
           multiple required class="w-full p-2 border rounded bg-gray-50">

    <div id="images-preview" class="flex flex-wrap gap-2"></div>

    <button type="submit"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">
      Add Car
    </button>
  </form>
</div>

<!-- ========================================================= -->
<!-- MANAGE CARS SECTION  -->
<!-- ========================================================= -->
<div id="col-carmanage" class="admin-section bg-white shadow rounded-lg p-6 mb-6">

  <h2 class="text-xl font-semibold mb-4">Manage Cars</h2>

  <div id="car-list" class="space-y-4"></div>

  <!-- Car Bookings Panel -->
  <div id="car-bookings-panel" class="hidden bg-gray-50 p-4 rounded mt-4">

    <div class="flex justify-between mb-2">
      <h3 class="font-semibold">
        Bookings for <span id="car-bookings-title"></span>
      </h3>

      <button id="close-car-bookings"
              class="bg-gray-300 hover:bg-gray-400 text-sm px-3 py-1 rounded">
        Close
      </button>
    </div>

    <div class="overflow-auto">
      <table class="w-full text-sm border-collapse">
        <thead class="bg-gray-200">
          <tr>
            <th class="border px-2 py-1">Booking ID</th>
            <th class="border px-2 py-1">Customer</th>
            <th class="border px-2 py-1">From</th>
            <th class="border px-2 py-1">To</th>
            <th class="border px-2 py-1">Amount</th>
            <th class="border px-2 py-1">Paid</th>
            <th class="border px-2 py-1">Verified</th>
          </tr>
        </thead>
        <tbody id="car-bookings-body"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- ========================================================= -->
<!-- QR VERIFICATION SECTION-->
<!-- ========================================================= -->
<div id="col-verify" class="admin-section bg-white shadow rounded-lg p-6 mb-6">

  <h2 class="text-xl font-semibold mb-4">Verify Payment (Scan QR)</h2>

  <div id="qr-result" class="text-sm mb-3"></div>

  <h3 class="font-medium mb-2">Camera Scanner</h3>

  <video id="video" width="100%" height="220"
         class="border rounded bg-black"></video>

  <div id="scan-status" class="text-sm mt-2">Waiting for cameraâ€¦</div>

  <button id="stop-scan"
          class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 mt-3 rounded">
    Stop Scan
  </button>

</div>

<!-- ========================================================= -->
<!-- BUSINESS DETAILS SECTION  -->
<!-- ========================================================= -->
<div id="section-business-details" class="admin-section bg-white shadow rounded-lg p-6 mb-6">

  <h2 class="text-xl font-semibold mb-4">Business Details</h2>

  <p class="text-gray-600 text-sm leading-relaxed">
    This section can be used to add:
    <br>â€¢ Company information  
    <br>â€¢ Contact details  
    <br>â€¢ GST Number  
    <br>â€¢ Address and more  
  </p>

</div>

<!-- ========================================================= -->
<!-- SHOW ALL SECTION -->
<!-- ========================================================= -->
<div id="section-all" class="admin-section bg-white shadow rounded-lg p-6 mb-6">

  <h2 class="text-xl font-semibold mb-4">All Sections</h2>

  <p class="text-gray-600 text-sm mb-4">
    This will display all sections together.
  </p>

</div>

      <!-- ========================================================= -->
<!-- RECENT TRANSACTIONS SECTION (ALWAYS VISIBLE) -->
<!-- ========================================================= -->
<div class="bg-white shadow rounded-lg p-6 mb-6">

  <h2 class="text-xl font-semibold mb-4">Recent Transactions</h2>

  <div class="overflow-auto">
    <table id="tx-table" class="w-full text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th class="border px-2 py-1">Payment ID</th>
          <th class="border px-2 py-1">Customer</th>
          <th class="border px-2 py-1">Car</th>
          <th class="border px-2 py-1">From</th>
          <th class="border px-2 py-1">To</th>
          <th class="border px-2 py-1">Amount</th>
          <th class="border px-2 py-1">Paid</th>
          <th class="border px-2 py-1">Verified</th>
        </tr>
      </thead>
      <tbody id="tx-body"></tbody>
    </table>
  </div>

</div>

</main>
</div>
</div>

<!-- ========================================================= -->
<!-- LIGHTBOX FOR VIEWING CAR IMAGES -->
<!-- ========================================================= -->
<div id="lightbox"
     class="fixed inset-0 hidden items-center justify-center z-50 bg-black bg-opacity-70">

  <div class="bg-white max-w-3xl w-full rounded-lg shadow-lg p-4 mx-4">
    <div class="flex justify-between mb-3">
      <h3 id="lb-title" class="font-semibold">Images</h3>
      <button id="lb-close"
              class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
        Close
      </button>
    </div>

    <div id="lb-images"
         class="flex gap-3 overflow-x-auto pb-2"></div>
  </div>

</div>

<!-- ========================================================= -->
<!-- FILTER + HELPER FUNCTIONS -->
<!-- ========================================================= -->
<script>
let allTransactions = []; // global for filtering

function escapeHtml(str) {
  if (!str) return "";
  return str.replace(/[&<>\"']/g, function (c) {
    return ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      "\"": "&quot;",
      "'": "&#39;"
    })[c];
  });
}

function showToast(message, color = "green") {
  const toast = document.createElement("div");
  toast.className =
    "fixed top-4 right-4 px-4 py-2 rounded text-white z-50 shadow";

  toast.style.background =
    color === "green"
      ? "#16a34a"
      : color === "red"
      ? "#dc2626"
      : "#4b5563";

  toast.innerText = message;
  document.body.appendChild(toast);

  setTimeout(() => toast.remove(), 3000);
}

function playSuccessSound() {
  try {
    new Audio(
      "https://cdn.pixabay.com/download/audio/2022/03/15/audio_2bda1e560f.mp3"
    )
      .play()
      .catch(() => {});
  } catch {}
}

/* ========================================================= */
/* LIGHTBOX CONTROL */
/* ========================================================= */
function openLightbox(images, title) {
  const lb = document.getElementById("lightbox");
  const lbImages = document.getElementById("lb-images");
  const lbTitle = document.getElementById("lb-title");

  lbImages.innerHTML = "";
  lbTitle.innerText = title;

  images.forEach((img) => {
    const im = document.createElement("img");
    im.src = img;
    im.className = "max-h-96 object-contain rounded shadow";
    lbImages.appendChild(im);
  });

  lb.classList.remove("hidden");
  lb.classList.add("flex");
}

document.getElementById("lb-close").addEventListener("click", () => {
  const lb = document.getElementById("lightbox");
  lb.classList.add("hidden");
  lb.classList.remove("flex");
});

/* ========================================================= */
/* SHOW SPECIFIC SECTION */
/* ========================================================= */
function showSection(id) {
  document
    .querySelectorAll(".admin-section")
    .forEach((sec) => (sec.style.display = "none"));

  const target = document.getElementById(id);
  if (target) {
    target.style.display = "block";
    target.scrollIntoView({ behavior: "smooth" });
  }
}
</script>

  <!-- ========================================================= -->
<!-- ADMIN FUNCTIONALITY + API LOGIC -->
<!-- ========================================================= -->
<script>
// ===============================================================
// AUTH HELPERS
// ===============================================================
function getAdminToken() {
  return sessionStorage.getItem("adminToken") || "";
}

function setAdminToken(token) {
  sessionStorage.setItem("adminToken", token);
  sessionStorage.setItem("adminLoggedIn", "1");

  document.getElementById("admin-login").classList.add("hidden");
  document.getElementById("admin-dashboard").classList.remove("hidden");

  loadCars();
  loadTransactions();
}

// ===============================================================
// LOGIN
// ===============================================================
document.getElementById("admin-login-btn").addEventListener("click", async () => {
  const email = document.getElementById("admin-email").value.trim();
  const password = document.getElementById("admin-password").value;
  const msg = document.getElementById("admin-login-msg");

  msg.innerText = "";

  try {
    if (!email || !password) throw new Error("Enter credentials");

    const res = await fetch(api("/api/admin/login"), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });

    const text = await res.text();
    const data = text ? JSON.parse(text) : {};

    if (!res.ok) throw new Error(data.message || "Login failed");

    setAdminToken(data.token);
  } catch (err) {
    msg.innerText = err.message;
  }
});

// ===============================================================
// NAVBAR LOGOUT
// ===============================================================
document.getElementById("navbar-logout").addEventListener("click", () => {
  sessionStorage.clear();
  location.reload();
});

// ===============================================================
// ADD CAR
// ===============================================================
document.getElementById("addCarForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const token = getAdminToken();
  if (!token) return alert("Login required");

  const fd = new FormData(e.target);
  const imgInput = document.getElementById("images-input");

  if (!imgInput.files.length) {
    alert("Select at least one image");
    return;
  }

  try {
    const res = await fetch(api("/api/admin/addcar"), {
      method: "POST",
      headers: { Authorization: "Bearer " + token },
      body: fd
    });

    const text = await res.text();
    const data = text ? JSON.parse(text) : {};

    if (!res.ok) throw new Error(data.message);

    showToast("Car Added âœ”", "green");
    e.target.reset();
    document.getElementById("images-preview").innerHTML = "";
    loadCars();
  } catch (err) {
    showToast(err.message, "red");
  }
});

// ===============================================================
// LOAD CARS
// ===============================================================
async function loadCars() {
  try {
    const res = await fetch(api("/api/cars"));
    const list = await res.json();

    const carList = document.getElementById("car-list");
    carList.innerHTML = "";

    if (!list.length) {
      carList.innerHTML = `<p class="text-gray-500">No cars available</p>`;
      return;
    }

    document.getElementById("stat-cars").innerText = list.length;

    list.forEach((car) => {
      let imgs = Array.isArray(car.images) ? car.images : [];
      imgs = imgs.map((img) =>
        img.startsWith("http") ? img : BACKEND_URL + "/" + img
      );

      const thumb = imgs[0] || "https://via.placeholder.com/140x90";

      const div = document.createElement("div");
      div.className =
        "flex justify-between items-center border rounded p-3 shadow-sm bg-white";

      div.innerHTML = `
        <div class="flex gap-3">
          <img src="${thumb}"
               data-images='${JSON.stringify(imgs)}'
               class="w-32 h-20 rounded border object-cover cursor-pointer">

          <div>
            <p class="font-semibold">${escapeHtml(car.brand)} ${escapeHtml(car.model)}</p>
            <p class="text-gray-600 text-sm">â‚¹${car.daily_rate} / day</p>
            <p class="text-gray-500 text-xs">${escapeHtml(car.location)}</p>
          </div>
        </div>

        <div class="flex gap-2">
          <button class="view-bookings bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded"
                  data-id="${car.id}" data-name="${car.brand} ${car.model}">
            Bookings
          </button>

          <button class="delete-car bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded"
                  data-id="${car.id}">
            Delete
          </button>
        </div>
      `;

      carList.appendChild(div);

      // lightbox
      div.querySelector("img").addEventListener("click", function () {
        const arr = JSON.parse(this.getAttribute("data-images"));
        openLightbox(arr, car.brand + " " + car.model);
      });

      // bookings
      div.querySelector(".view-bookings").addEventListener("click", () => {
        loadCarBookings(car.id, car.brand + " " + car.model);
      });

      // delete
      div.querySelector(".delete-car").addEventListener("click", () => {
        deleteCar(car.id);
      });
    });
  } catch (err) {
    console.error(err);
  }
}

// ===============================================================
// DELETE CAR
// ===============================================================
async function deleteCar(id) {
  if (!confirm("Delete this car?")) return;

  try {
    const token = getAdminToken();
    const res = await fetch(api("/api/deletecar"), {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + token
      },
      body: JSON.stringify({ car_id: id })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message);

    showToast("Car deleted", "green");
    loadCars();
  } catch (err) {
    showToast(err.message, "red");
  }
}

// ===============================================================
// LOAD BOOKINGS FOR A CAR
// ===============================================================
async function loadCarBookings(carId, carName) {
  const panel = document.getElementById("car-bookings-panel");
  const body = document.getElementById("car-bookings-body");

  panel.classList.remove("hidden");
  document.getElementById("car-bookings-title").innerText = carName;
  body.innerHTML = "<tr><td colspan='7'>Loading...</td></tr>";

  try {
    const res = await fetch(api(`/api/car-bookings/${carId}`));
    const list = await res.json();

    body.innerHTML = "";

    if (!list.length) {
      body.innerHTML = "<tr><td colspan='7'>No bookings</td></tr>";
      return;
    }

    list.forEach((b) => {
      body.innerHTML += `
      <tr>
        <td class="border px-2 py-1">${b.id}</td>
        <td class="border px-2 py-1">${escapeHtml(b.customer_name || "")}</td>
        <td class="border px-2 py-1">${new Date(b.start_date).toLocaleDateString()}</td>
        <td class="border px-2 py-1">${new Date(b.end_date).toLocaleDateString()}</td>
        <td class="border px-2 py-1">â‚¹${b.amount}</td>
        <td class="border px-2 py-1">${b.paid ? "Yes" : "No"}</td>
        <td class="border px-2 py-1">${b.verified ? "Yes" : "No"}</td>
      </tr>`;
    });
  } catch (err) {
    body.innerHTML = "<tr><td colspan='7'>Error loading bookings</td></tr>";
  }
}

document.getElementById("close-car-bookings").addEventListener("click", () => {
  document.getElementById("car-bookings-panel").classList.add("hidden");
});

// ===============================================================
// LOAD TRANSACTIONS
// ===============================================================
async function loadTransactions() {
  try {
    const token = getAdminToken();
    const res = await fetch(api("/api/admin/transactions?page=1&pageSize=100"), {
      headers: { Authorization: "Bearer " + token }
    });

    const data = await res.json();
    allTransactions = data.data || [];

    const tbody = document.getElementById("tx-body");
    tbody.innerHTML = "";

    allTransactions.forEach((tx) => {
      tbody.innerHTML += `
      <tr>
        <td class="border px-2 py-1">${tx.payment_id}</td>
        <td class="border px-2 py-1">${escapeHtml(tx.name)}</td>
        <td class="border px-2 py-1">${escapeHtml(tx.brand)} ${escapeHtml(tx.model)}</td>
        <td class="border px-2 py-1">${new Date(tx.start_date).toLocaleDateString()}</td>
        <td class="border px-2 py-1">${new Date(tx.end_date).toLocaleDateString()}</td>
        <td class="border px-2 py-1">â‚¹${tx.amount}</td>
        <td class="border px-2 py-1">${tx.paid ? "Yes" : "No"}</td>
        <td class="border px-2 py-1">${tx.verified ? "Yes" : "No"}</td>
      </tr>`;
    });

    document.getElementById("stat-bookings").innerText = allTransactions.length;
    document.getElementById("stat-pending").innerText =
      allTransactions.filter((tx) => !tx.paid).length;
  } catch (err) {
    console.error(err);
  }
}

// ===============================================================
// FILTER SYSTEM
// ===============================================================
document.getElementById("filter-apply").addEventListener("click", () => {
  const q = document.getElementById("filter-search").value.toLowerCase();
  const from = document.getElementById("filter-from").value;
  const to = document.getElementById("filter-to").value;

  let fromDate = from ? new Date(from) : null;
  let toDate = to ? new Date(to) : null;

  if (toDate) toDate.setHours(23, 59, 59, 999);

  const filtered = allTransactions.filter((tx) => {
    let match = true;

    if (q) {
      const text =
        `${tx.payment_id} ${tx.name} ${tx.brand} ${tx.model}`.toLowerCase();
      if (!text.includes(q)) match = false;
    }

    if (match && (fromDate || toDate)) {
      const d = new Date(tx.start_date);
      if (fromDate && d < fromDate) match = false;
      if (toDate && d > toDate) match = false;
    }

    return match;
  });

  document.getElementById("stat-bookings").innerText = filtered.length;
  document.getElementById("stat-pending").innerText =
    filtered.filter((tx) => !tx.paid).length;

  renderTransactions(filtered);
});

document.getElementById("filter-clear").addEventListener("click", () => {
  document.getElementById("filter-search").value = "";
  document.getElementById("filter-from").value = "";
  document.getElementById("filter-to").value = "";

  renderTransactions(allTransactions);

  document.getElementById("stat-bookings").innerText = allTransactions.length;
  document.getElementById("stat-pending").innerText =
    allTransactions.filter((tx) => !tx.paid).length;
});

// ===============================================================
// QR SCANNER
// ===============================================================
let videoStream = null;

async function startScan() {
  const video = document.getElementById("video");
  const status = document.getElementById("scan-status");

  status.innerText = "Starting camera...";

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });

    video.srcObject = stream;
    videoStream = stream;
    video.play();

    status.innerText = "Scanning...";

    if (window.BarcodeDetector) {
      const detector = new BarcodeDetector({ formats: ["qr_code"] });

      const scanLoop = async () => {
        const codes = await detector.detect(video);
        if (codes.length) {
          stopScan();
          verifyQr(codes[0].rawValue);
          return;
        }
        requestAnimationFrame(scanLoop);
      };

      requestAnimationFrame(scanLoop);
    }
  } catch {
    status.innerText = "Camera error.";
  }
}

function stopScan() {
  if (videoStream) {
    videoStream.getTracks().forEach((t) => t.stop());
  }
  document.getElementById("scan-status").innerText = "Stopped";
}

document.getElementById("stop-scan").addEventListener("click", stopScan);

// ===============================================================
// VERIFY QR
// ===============================================================
async function verifyQr(code) {
  const token = getAdminToken();
  const status = document.getElementById("scan-status");

  status.innerText = "Verifying...";

  try {
    let qrData;
    try {
      qrData = JSON.parse(code);
    } catch {
      qrData = { booking_id: code };
    }

    const res = await fetch(api("/api/admin/verify-qr"), {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + token
      },
      body: JSON.stringify({ qr_data: qrData })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message);

    showToast("Verified âœ“", "green");
    playSuccessSound();

    document.getElementById("qr-result").innerHTML = `
      <div class="bg-green-100 p-3 rounded border border-green-300">
        <p><b>Booking:</b> ${data.booking_id}</p>
        <p><b>Customer:</b> ${data.customer?.name}</p>
        <p><b>Car:</b> ${data.car}</p>
        <p><b>Amount:</b> â‚¹${data.amount}</p>
      </div>
    `;

    loadTransactions();
    loadCars();
  } catch (err) {
    showToast(err.message, "red");
    status.innerText = "Verification failed";
  }
}

// ===============================================================
// INITIALIZE PAGE
// ===============================================================
(function () {
  const token = getAdminToken();

  if (token) {
    document.getElementById("admin-login").classList.add("hidden");
    document.getElementById("admin-dashboard").classList.remove("hidden");

    loadCars();
    loadTransactions();
  }
})();
</script>

</body>
</html>
